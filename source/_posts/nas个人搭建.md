---
title: nas个人搭建
toc: true
date: 2021-12-06 11:06:10
tags:
- DIY
categories:
- 其他
---
nas可以作为家庭数据库，电脑、平板、手机、电视等设备连入nas可以方便的查看照片、视频、音乐等
<!--more-->
# 主流方案
主要是[群晖](https://www.synology.cn/zh-cn),如果不想费事，直接买

# DIY
## 准备硬件
- CPU，8700T
- 主板，华硕的B360i主板，两个M2接口（NVME和NVME+SATA），四个SATA接口。后置有HDMI、DP，USB 3.0 type C及type A和一个千兆网口。
- 内存，三星的8GB 2666Mhz的DDR4
- 系统盘，512GB 的Intel 660p
- 机箱，黑群晖的专用机箱，可选2/4/6/8盘位
- 硬盘，4TB东芝的N300

## 部署软件
- 操作系统，可选FreeNAS、黑群晖、Ubuntu
- 共享方案，SMB方案，在Ubuntu下安装及配置Samba（SMB）服务并不复杂。Samba的登陆账户必须是Unix的账户，因此创建Samba用户的前提先创建Unix账户。
- http支持，Apache，Apache安装好后需要在/etc/apache2/文件夹里修改及配置，比如路径，端口等。默认的访问目录是系统的/var/log/www/。如果你的用户目录是在/home（比如/home/user1）里，那只要把/etc/apache2/sites-available/*.conf里的Document root项改成你要的目录就可以。这样在打开游览器输入地址时就可以访问到每个用户的文件夹。如果有通过公网访问，建议改用HTTPS。如果直接这样访问的话大家的隐私就没了，因此需要加一个身份认证（user authentication）限制，以对应于不同的用户。Apache自带一套认证系统mod-authz【10】，通过htpasswd命令及.htaccess来实现。htpasswd负责创立用户及密码，而.htaccess文件则是对所在的路径及其子路径加上限制。这样一来通过游览器访问时就会出现认证的窗口让用户输入密码，实现了访问限制。
- 影音服务器，NAS的另一个功能就是作为影音服务器（Media Server），把视频转码stream到电脑手机甚至电视机。目前使用比较广泛的是Plex Media Server。Plex的转码是在服务器端，因此这方面对硬件（CPU及内存）有要求。而客户端方面的支持也非常到位。Android或iOS都有对应的应用，或者可以直接在网页游览器上观赏视频。无论是客厅的大屏幕电视机，还是躺在床上用手机，都可以直接观赏NAS服务器里的电影。
- RAID，。除了一般提到的RAID 0,1,10,5,6等，RAID又分硬RAID和软RAID。硬RAID是在硬件层面（RAID扩展卡，主板Bios）实现硬盘冗余，而软RAID则是在操作系统层面完成。正常情况（条件允许）下，推荐使用的都是硬RAID。
>Ubuntu可以通过MDADM和ZFS来组RAID。ZFS（Zettabyte File System）其实是集合文件系统+磁盘管理+RAID管理三项功能一个的软件。ZFS的Snapshot、Copy-on-write及大容量等都是它比一般的RAID方案有优势的地方。实际上，很多优势对一般用户都用不上。
考虑以后可能需要扩充RAID容量，因此还是老实地选择传统的RAID方案（MDADM）。虽然ZFS利用内存来缓存以提高速度是一个不错的特点，但是在传输过程中瓶颈的大概率来自网络。至于RAID级别，目前没有太高容量需求，可以用两个4TB硬盘先组RAID 1。以后增加硬盘时才换RAID 5。RAID 5的缺点是数据重建时很慢。在长时间的重建时出现第二个硬盘损坏的话所有的数据就全毁了。

- 外网访问，如果需外从外网访问，最好的情况是有公网IP，然后用动态域名（DDNS）。域名供应商主要的有花生壳，如果免费的话是没法选域名（系统分配）。另一个动态域名解析商是NOIP，NOIP提供三个免费域名，而且可以自己选择域名（只要不冲突），而NOIP会在后方加个.http://ddns.net或.http://xxx.com（免费的嘛，已经算良心了）。唯一麻烦的是每30天需要自己登陆到网页更新域名，不然NOIP就取消你申请的域名。NOIP的另一个好处是不需要实名认证，如果有钱想买个域名的话也无需备案，只要有Paypal账户（或比特币）就可以即时申请到你想要的域名。
- 安全及隐私，对于降低入侵，尽量减少对外网开放的端口。个人建议是只开放端口22做远程管理及80/443做网页访问。其余的如SMB的139/445或FTP的端口20/21尽量关闭。另外，远程管理方面，其他人不需要使用到SSH做远程管理。为了减低被暴力破解的风险，需要去除其他人远程登陆的权限【18】（如果有端口22对外开放的话，可以检测SSH的登陆log（/log/auth.log），会发现不少通过bot来暴力破解的尝试）。另一个方法是改用其他冷门端口，比如自己的生日等。
至于SMB或FTP传输，可以搭建VPN加密。这里提供比较容易搭建的PPTP方案。基本上就是在安装pptpd后，在设置文件/etc/ppp/chap-secrects中添加登陆账户及分配IP后，启动pptpd服务就完成了【19】。也可以直接买刷了DD-WRT固件的路由器。DD-WRT下部署PPTP VPN更加简单。客户端除了iOS不支持PPTP之外，其他的操作系统都可以连接PPTP的VPN，而且设置也不难。事实上PPTP协议中的加密算法已经在多年以前被证实是不安全，但至少比完全没有会更安全一些。有精力的话再去折腾L2TP或其他的。（Ubuntu默认的权限是755）。
至于隐私方面，除了共享文件夹的权限是777，所有的私人文件权限都改成750（Ubuntu默认的权限是755）。
